<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>A.2.&nbsp;Using ODBC to retrieve data from DHIS2 into R</title><link rel="stylesheet" type="text/css" href="resources/css/docbook_bsd.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><meta name="keywords" content="DHIS2, HMIS, aggregate data, Health Management Information System, Integrated data repository, Health Information System"><link rel="home" href="dhis2_developer_manual.html" title="DHIS2 Developer Manual"><link rel="up" href="apa.html" title="Appendix&nbsp;A.&nbsp;R and DHIS 2 Integration"><link rel="prev" href="apa.html" title="Appendix&nbsp;A.&nbsp;R and DHIS 2 Integration"><link rel="next" href="apas03.html" title="A.3.&nbsp;Using R with MyDatamart"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">A.2.&nbsp;Using ODBC to retrieve data from DHIS2 into R</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="apa.html">Prev</a>&nbsp;</td><th width="60%" align="center">Appendix&nbsp;A.&nbsp;R and DHIS 2 Integration</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="apas03.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dhis2_r_odbc"></a>A.2.&nbsp;Using ODBC to retrieve data from DHIS2 into R</h2></div></div></div>
    
    <p>In this example, we will use a system-wide ODBC connector which will be used to retrieve data from the DHIS2 database. There are some disadvantages with this approach, as ODBC is slower than other methods and it does raise some security concerns by providing a system-wide connector to all users. However, it is a convenient method to provide a connection to multiple users. The use of the R package RODBC will be used in this case. Other alternatives would be the use of the <a class="ulink" href="http://dirk.eddelbuettel.com/code/rpostgresql.html" target="_top">RPostgreSQL</a> package, which can interface directly through the  Postgresql driver described in <a class="xref" href="apas04.html" title="A.4.&nbsp;Mapping with R and PostgreSQL">Section&nbsp;A.4, &#8220;Mapping with R and PostgreSQL&#8221;</a></p>
    <p>Assuming you have already installed R from the procedure in the previous section. Invoke the following command to add the required libraries for this example.</p>
    <p><span class="command"><strong>apt-get install r-cran-rodbc r-cran-lattice odbc-postgresql</strong></span> </p>
    <p>Next, we need to configure the ODBC connection. Edit the file to suit your local situation using the following template as a guide. Lets create and edit a file called odbc.ini</p>
    <pre class="screen">[dhis2]
Description         = DHIS2 Database
Driver              = /usr/lib/odbc/psqlodbcw.so
Trace               = No
TraceFile           = /tmp/sql.log
Database            = dhis2
Servername          = 127.0.0.1
UserName            = postgres
Password            = SomethingSecure
Port                = 5432
Protocol            = 9.0
ReadOnly            = Yes
RowVersioning       = No
ShowSystemTables    = No
ShowOidColumn       = No
FakeOidIndex        = No
ConnSettings        =
Debug = 0</pre><p>
</p>
    <p>Finally, we need to install the ODBC connection with <span class="command"><strong>odbcinst -i -d -f odbc.ini</strong></span></p>
    <p></p>
    <p>From the R prompt, execute the following commands to connect to the DHIS2 database. </p>
    <pre class="screen">&gt; library(RODBC)
&gt; channel&lt;-odbcConnect("dhis2")#Note that the name must match the ODBC connector name
&gt; sqlTest&lt;-c("SELECT dataelementid, name FROM dataelement LIMIT 10;")
&gt; sqlQuery(channel,sqlTest)
                                                                        name
1   OPD First Attendances Under 5
2   OPD First Attendances Over 5
3   Deaths Anaemia Under 5 Years
4   Deaths Clinical Case of Malaria Under 5 Years
5   Inpatient discharges under 5
6   Inpatient Under 5 Admissions
7   Number ITNs
8   OPD 1st Attendance Clinical Case of Malaria Under 5
9  IP Discharge Clinical Case of Malaria Under 5 Years
10 Deaths of malaria case provided with anti-malarial treatment 1 to 5 Years
&gt;
</pre>
    <p>It seems R is able to retrieve data from the DHIS2 database. </p>
    <p>As an illustrative example, lets say we have been asked to calculate the relative percentage of OPD male and female under 5 attendances for the last twelve months.First, lets create an SQL query which will provide us the basic information which will be required.</p>
    <pre class="screen">OPD&lt;-sqlQuery(channel,"SELECT p.startdate, de.name as de, sum(dv.value::double precision)
 FROM datavalue dv
 INNER JOIN period p on dv.periodid = p.periodid
 INNER JOIN dataelement de on dv.dataelementid = de.dataelementid
 WHERE p.startdate &gt;= '2011-01-01'
 and p.enddate &lt;= '2011-12-31'
 and de.name ~*('Attendance OPD')
 GROUP BY p.startdate, de.name;")</pre>
    <p>We have stored the result of the SQL query in an R data frame called "OPD". Lets take a look at what the data looks like. </p>
    <pre class="screen">&gt; head(OPD)
   startdate                                 de    sum
1 2011-12-01   Attendance OPD &lt;12 months female  42557
2 2011-02-01   Attendance OPD &lt;12 months female 127485
3 2011-01-01   Attendance OPD 12-59 months male 200734
4 2011-04-01   Attendance OPD 12-59 months male 222649
5 2011-06-01   Attendance OPD 12-59 months male 168896
6 2011-03-01 Attendance OPD 12-59 months female 268141
&gt; unique(OPD$de)
[1] Attendance OPD &lt;12 months female   Attendance OPD 12-59 months male  
[3] Attendance OPD 12-59 months female Attendance OPD &gt;5 years male      
[5] Attendance OPD &lt;12 months male     Attendance OPD &gt;5 years female    
6 Levels: Attendance OPD 12-59 months female ... Attendance OPD &gt;5 years male
&gt; 
          </pre><p>
</p>
    <p>We can see that we need to aggregate the two age groups (&lt; 12 months and 12-59 months) into a single variable, based on the gender. Lets reshape the data into a crosstabulated table  to make this easier to visualize and calculate the summaries.</p>
    <pre class="screen">&gt;OPD.ct&lt;-cast(OPD,startdate ~ de) 
&gt;colnames(OPD.ct)
[1] "startdate"                          "Attendance OPD 12-59 months female"
[3] "Attendance OPD 12-59 months male"   "Attendance OPD &lt;12 months female"  
[5] "Attendance OPD &lt;12 months male"     "Attendance OPD &gt;5 years female"    
[7] "Attendance OPD &gt;5 years male" </pre><p>     
</p>
    <p>We have reshaped the data so that the data elements are individual columns. It looks like we need to aggregate the second and fourth columns together to get the under 5 female attendance, and then the third and fifth columns to get the male under 5 attendance.After this, lets subset the data into a new data frame just to get the required information and display the results.</p>
    <pre class="screen">&gt; OPD.ct$OPDUnder5Female&lt;-OPD.ct[,2]+OPD.ct[,4]#Females
&gt; OPD.ct$OPDUnder5Male&lt;-OPD.ct[,3]+OPD.ct[,5]#males
&gt; OPD.ct.summary&lt;-OPD.ct[,c(1,8,9)]#new summary data frame
&gt;OPD.ct.summary$FemalePercent&lt;-
OPD.ct.summary$OPDUnder5Female/
(OPD.ct.summary$OPDUnder5Female + OPD.ct.summary$OPDUnder5Male)*100#Females
&gt;OPD.ct.summary$MalePercent&lt;-
OPD.ct.summary$OPDUnder5Male/
(OPD.ct.summary$OPDUnder5Female + OPD.ct.summary$OPDUnder5Male)*100#Males </pre>
    <p>Of course, this could be accomplished much more elegantly, but for the purpose of the illustration, this code is rather verbose.Finally, lets display the required information.</p>
    <pre class="screen">&gt; OPD.ct.summary[,c(1,4,5)]
    startdate FemalePercent MalePercent
1  2011-01-01      51.13360    48.86640
2  2011-02-01      51.49154    48.50846
3  2011-03-01      51.55651    48.44349
4  2011-04-01      51.19867    48.80133
5  2011-05-01      51.29902    48.70098
6  2011-06-01      51.66519    48.33481
7  2011-07-01      51.68762    48.31238
8  2011-08-01      51.49467    48.50533
9  2011-09-01      51.20394    48.79606
10 2011-10-01      51.34465    48.65535
11 2011-11-01      51.42526    48.57474
12 2011-12-01      50.68933    49.31067</pre>
    <p>We can see that the male and female attendances are very similar for each month of the year, with seemingly higher male attendance relative to female attendance in the month of December.</p>
    <p>In this example, we showed how to retrieve data from the DHIS2 database and manipulate in with some simple R commands. The basic pattern for using DHIS2 and R together, will be the retrieval of data from the DHIS2 database with an SQL query into an R data frame, followed by whatever routines (statistical analysis, plotting, etc) which may be required.  </p>
  </div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="apa.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="apa.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="apas03.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Appendix&nbsp;A.&nbsp;R and DHIS 2 Integration&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="dhis2_developer_manual.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;A.3.&nbsp;Using R with MyDatamart</td></tr></table></div></body></html>